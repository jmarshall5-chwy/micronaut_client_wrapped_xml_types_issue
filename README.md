# Micronaut not properly wrapping XML entities
This example demonstrates that Micronaut doesn't wrap array/collection objects
properly when the `@JacksonXmlElementWrapper(localName = "nestedItems")`
annotation is used.

# This repo/project is public domain

## This test project
This project is a simple Micronaut server that uses a simple data structure
as follows:
```java
@JsonRootName(value = "SimpleRequest")
@JsonIgnoreProperties(ignoreUnknown = true)
public class Request {
    private @NotEmpty String id;
    
    @JacksonXmlElementWrapper(localName = "nestedItems")
    private @NotEmpty List<NestedItem> nestedItem;
}
```

With the above annotations the generated XML should look like this
```xml
<SimpleRequest>
    <id>1</id>
    <nestedItems>
        <nestedItem>
            <containerId>22</containerId>
            <someData>something</someData>
        </nestedItem>
        <nestedItem>
            <containerId>23</containerId>
            <someData>something else</someData>
        </nestedItem>
    </nestedItems>
</SimpleRequest>
```

however, the XML that is generated by the Micronaut encoder is as follows
```xml
<SimpleRequest>
    <id>1</id>
    <nestedItem>
        <containerId>22</containerId>
        <someData>something</someData>
    </nestedItem>
    <nestedItem>
        <containerId>23</containerId>
        <someData>something else</someData>
    </nestedItem>
</SimpleRequest>
```

The only solution is to not use wrapped XML types, which requires the
following annotation change: `@JacksonXmlElementWrapper(useWrapping = false)`

## Issue
The problem appears to stem from the **BeanIntrospectionModule.java** class,
at line 797 (Micronaut v2.5.7), there is an if statement which checks the
_unwrapping_ flag. If it is not unwrapped then the code proceeds to writing
the field, however; it fails to create a wrapper if needed. Specifically
instead of just writing the field name at line 801 there needs to be a check
before and after that call to write the wrapper tag.

Here is the code from **BeanIntrospectionModule.java**
```java
    @Override
    public final void serializeAsField(Object bean, JsonGenerator gen, SerializerProvider prov) throws Exception {
    // lines 756 - 796
            if (isUnwrapping()) {
                JsonSerializer<Object> unwrappingSerializer = ser.unwrappingSerializer(null);
                unwrappingSerializer.serialize(value, gen, prov);
            } else {
/*line 801*/    gen.writeFieldName(fastName);
                if (_typeSerializer == null) {
                    ser.serialize(value, gen, prov);
                } else {
                    ser.serializeWithType(value, gen, prov, _typeSerializer);
                }
            }
    }
```
Here is the equivalent code from **XmlBeanPropertyWriter.java** in Jackson
v2.12.4

```java
    @Override
    public void serializeAsField(Object bean, JsonGenerator jgen, SerializerProvider prov)
        throws Exception
    {
        // lines 80 - 136
        final ToXmlGenerator xmlGen = (jgen instanceof ToXmlGenerator) ? (ToXmlGenerator) jgen : null;
        // Ok then; addition we want to do is to add wrapper element, and that's what happens here
        // 19-Aug-2013, tatu: ... except for those nasty 'convertValue()' calls...
        if (xmlGen != null) {
            xmlGen.startWrappedValue(_wrapperQName, _wrappedQName);
        }
        jgen.writeFieldName(_name);
        if (_typeSerializer == null) {
            ser.serialize(value, jgen, prov);
        } else {
            ser.serializeWithType(value, jgen, prov, _typeSerializer);
        }
        if (xmlGen != null) {
            xmlGen.finishWrappedValue(_wrapperQName, _wrappedQName);
        }
    }
```

You can see on line 137 there is an `instanceof` check to see if we are
working with XML, if so it then calls the generators start & finish wrapped
value functions.

## Running this test
```shell
./gradlew test --tests "com.example.Xml_wrapperTest.doBasicXmlRequest" --info
```
The test will fail and if you look at the traces you'll see that the XML is a shown
above, and the response from the server is:
_io.micronaut.http.client.exceptions.HttpClientResponseException: request.nestedItem: must not be empty_

## Solution
Since **BeanIntrospectionModule.java** purpose is to remove any reflection
code from the serialization/deserialization, there doesn't appear to be an
easy solution, since there is no way to know if the generator used is
for XML, JSON or other. The functions in question _startWrappedValue_ &
_finishWrappedValue_ are not part of the **GeneratorBase** or
**JsonGenerator** contract (class/interface), so they can't just be called.